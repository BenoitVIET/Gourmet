<!DOCTYPE html>
<html lang="en">
    <head>    
    <meta charset="UTF-8">    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <title>Recipes</title>    <link rel="shortcut icon" href="../assets/icons/logo.jpg" type="image/x-icon">
    <script defer src="../main.js"></script>
    <script defer src="../js/utils.js"></script>
    <script defer src="../js/recettes-data.js"></script>
    <script defer src="../js/api-functions.js"></script>
    <script defer src="../js/favorites-manager.js"></script>
    <script defer src="../js/recipe-display.js"></script>
    <script defer src="../js/app-init.js"></script>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="../css/benoit.css">
    <link rel="stylesheet" href="../css/laura.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oxygen:wght@300;400;700&family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    </head>
    
    <body>
        <header>
            <nav>
                <ul class="toggle">
                    <li class="closeBtnMenu"> <img src="../assets/icons/close.png" alt="close menu button"></li>
                    <li><a href="../index.html">Accueil</a></li>
                    <li><a href="#">Ajouter une recette</a></li>
                    <li><a href="favoris.html">Mes favoris</a></li>
                    <li><a href="a_propos.html">√Ä propos</a></li>
                </ul>

                <section class="title">
                    <div><a href="../index.html">G</a></div>
                    <h1>GourmetTech</h1>
                </section>
                <ul class="menuList">
                    <li><a href="../index.html">Accueil</a></li>
                    <li><a href="#">Ajouter une recette</a></li>
                    <li><a href="favoris.html">Mes favoris</a></li>
                      <li><a href="a_propos.html">√Ä propos</a></li>
                    <li><img class="burgerBtn" src="../assets/icons/menu-burger.png" alt="menu burger"/></li>
                </ul>

                <div class="picto">
                    <img src="../assets/icons/moon.png" alt="change light mode" id="moon"/>
                    <img src="../assets/icons/sunny.png" alt="change light mode" id="sun"/>
                </div>
            </nav>
        </header>
            
            <main>
                <div class="detailRecepie">
                    <button id="favoriButton" class="recepieButton">Ajouter aux favoris</button>
                
                <div id="recetteContainer" class="hidden">    
                    <div class="recette-header">
                        <h1 id="titreRecette"></h1>    
                        <img id="imageRecette" src="" alt="Image de la recette" class="recette-image">
                    </div>
                    
                    <div class="recette-info-grid">
                        <div class="filterMain">
                            <strong>üçΩÔ∏è Cat√©gorie</strong><br>
                            <span id="categorieRecette"></span>
                        </div>
                        <div class="filterMain">
                            <strong>‚è±Ô∏è Temps</strong><br>
                            <span id="tempsRecette"></span>
                        </div>
                        <div class="filterMain">
                            <strong>‚≠ê Difficult√©</strong><br>
                            <span id="difficulteRecette"></span>
                        </div>
                        <div class="filterMain">
                            <strong>üë• Personnes</strong><br>
                            <span id="nbPersonnesRecette"></span>
                        </div>
                    </div>        
                    
                    <div class="ingredients-etapes-grid">
                        <div class="filterMain">
                            <h2>üõí Ingr√©dients</h2>    
                            <ul id="ingredientsList"></ul>
                        </div>
                        
                        <div class="filterMain">
                            <h2>üë©‚Äçüç≥ √âtapes de pr√©paration</h2>    
                            <ol id="etapesList"></ol>
                        </div>
                    </div>
                    
                    <div class="filterMain">
                        <h2>üí° Suggestions de recettes similaires</h2>    
                        <div id="suggestionsList"></div>
                    </div>
                    
                    <a href="../index.html" class="recetteButton">‚Üê Retour aux recettes</a>
                </div>
            </div>
            </main>
            
            <footer>
                <hr />
                <section>
                    <div class="navAbout">
                        <h4>Navigation</h4>
                        <ul class="footer-nav-list">
                            <li class="footer-nav-item"><a href="../index.html" class="footer-nav-link">Accueil</a></li>
                            <li class="footer-nav-item"><a href="recettes.html" class="footer-nav-link">Ajouter une recette</a></li>
                            <li class="footer-nav-item"><a href="favoris.html" class="footer-nav-link">Mes favoris</a></li>
                            <li class="footer-nav-item"><a href="a_propos.html" class="footer-nav-link">√Ä propos</a></li>
                        </ul>
                    </div>
                    <div class="navAbout">
                        <h4>√Ä propos de GourmetTech</h4>
                        <p>GourmetTech est une plateforme de recettes culinaires interactives, dans le cadre d'un projet p√©dagogique.</p>
                    </div>
                </section>
                <hr />
                <div class="copyright">
                    <p>&copy; 2025 GourmetTech - Tous droits r√©serv√©s</p>
                </div>
            </footer>
        <script>
        // Script d'affichage dynamique de la recette (locale ou API)
        function getRecipeIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('recette');
        }

        function showRecipeError(message) {
            let errorContainer = document.getElementById('errorContainer');
            if (!errorContainer) {
                errorContainer = document.createElement('div');
                errorContainer.id = 'errorContainer';
                errorContainer.style.margin = '30px auto';
                errorContainer.style.maxWidth = '500px';
                errorContainer.style.textAlign = 'center';
                document.body.appendChild(errorContainer);
            }
            errorContainer.innerHTML = `<div style="background:#f8d7da;color:#721c24;padding:20px;border-radius:8px;font-size:1.2em;">${message}</div>`;
            errorContainer.style.display = 'block';
        }

        async function fetchApiRecipeById(id) {
            // TheMealDB: recherche par id
            const url = `https://www.themealdb.com/api/json/v1/1/lookup.php?i=${id}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.meals && data.meals.length > 0) {
                    return data.meals[0];
                }
            } catch (e) {}
            return null;
        }

        function updateFavoriButton(recetteId, isApi, titre, img) {
            const btn = document.getElementById('favoriButton');
            let favorites = [];
            try { favorites = JSON.parse(localStorage.getItem('gourmet-favorites')) || []; } catch (e) {}
            const isFavorite = favorites.some(fav => fav.id === recetteId);
            btn.textContent = isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris';
            btn.style.backgroundColor = isFavorite ? 'rgb(195, 74, 74)' : 'rgb(230, 127, 33)';
            btn.onclick = function () {
                let favorites = [];
                try { favorites = JSON.parse(localStorage.getItem('gourmet-favorites')) || []; } catch (e) {}
                const index = favorites.findIndex(fav => fav.id === recetteId);
                if (index === -1) {
                    favorites.push({ id: recetteId });
                    btn.textContent = 'Retirer des favoris';
                    btn.style.backgroundColor = 'rgb(195, 74, 74)' 
                } else {
                    favorites.splice(index, 1);
                    btn.textContent = 'Ajouter aux favoris';
                     btn.style.backgroundColor = 'rgb(230, 127, 33)' 
                }
                localStorage.setItem('gourmet-favorites', JSON.stringify(favorites));
            };
        }

        async function fetchApiSuggestions(category) {
            // Correction du mapping cat√©gorie locale ‚Üí API
            const map = {
                'dessert': 'Dessert',
                'plat': 'Beef',
                'entr√©e': 'Starter',
                'chicken': 'Chicken',
                'vegetarian': 'Vegetarian',
                'seafood': 'Seafood',
                'miscellaneous': 'Miscellaneous'
            };
            let apiCat = map[category.toLowerCase()] || 'Miscellaneous';
            const url = `https://www.themealdb.com/api/json/v1/1/filter.php?c=${encodeURIComponent(apiCat)}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.meals) {
                    return data.meals.slice(0, 3); // 3 suggestions
                }
            } catch (e) {}
            return [];
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const recetteId = getRecipeIdFromUrl();
            if (!recetteId) {
                showRecipeError('Aucune recette s√©lectionn√©e.');
                return;
            }

            // Chercher la recette locale
            let recette = null;
            if (window.recepies) {
                recette = window.recepies.find(r => r.title.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '') === recetteId);
            }

            let isApiRecipe = false;
            let apiRecipe = null;
            // Si non trouv√©e en local, tenter API (TheMealDB)
            if (!recette) {
                // On suppose que l'ID API est num√©rique (TheMealDB)
                if (/^\d+$/.test(recetteId)) {
                    apiRecipe = await fetchApiRecipeById(recetteId);
                    if (apiRecipe) isApiRecipe = true;
                }
            }

            if (!recette && !isApiRecipe) {
                showRecipeError('Recette non trouv√©e.');
                return;
            }

            document.getElementById('recetteContainer').classList.remove('hidden');
            if (recette) {
                document.getElementById('titreRecette').textContent = recette.title;
                document.getElementById('imageRecette').src = '../' + recette.img;
                document.getElementById('imageRecette').alt = recette.alt || recette.title;
                document.getElementById('categorieRecette').textContent = recette.category;
                document.getElementById('tempsRecette').textContent = recette.timePrep;
                document.getElementById('difficulteRecette').textContent = recette.difficulty;
                document.getElementById('nbPersonnesRecette').textContent = recette.nbPersonnes;

                // Favoris
                updateFavoriButton(recette.title.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, ''), false, recette.title, recette.img);

                // Ingr√©dients
                const ingredientsList = document.getElementById('ingredientsList');
                ingredientsList.innerHTML = '';
                if (recette.ingredients && Array.isArray(recette.ingredients)) {
                    recette.ingredients.forEach(ingredient => {
                        const li = document.createElement('li');
                        li.textContent = ingredient;
                        ingredientsList.appendChild(li);
                    });
                }

                // √âtapes
                const etapesList = document.getElementById('etapesList');
                etapesList.innerHTML = '';
                if (recette.etapes && Array.isArray(recette.etapes)) {
                    recette.etapes.forEach(etape => {
                        const li = document.createElement('li');
                        li.textContent = etape;
                        etapesList.appendChild(li);
                    });
                }

                // Suggestions API uniquement
                const suggestionsList = document.getElementById('suggestionsList');
                suggestionsList.innerHTML = '';
                const apiSuggestions = await fetchApiSuggestions(recette.category);
                apiSuggestions.forEach(sugg => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-card';
                    // Ajout du bouton coeur
                    let favorites = [];
                    try { favorites = JSON.parse(localStorage.getItem('gourmet-favorites')) || []; } catch (e) {}
                    const isFavorite = favorites.some(fav => fav.id === sugg.idMeal);
                    const heartSrc = isFavorite ? "../assets/icons/redHeart.png" : "../assets/icons/grayHeart.png";
                    div.innerHTML = `<img src="${sugg.strMealThumb}" alt="${sugg.strMeal}" style="width:60px;height:60px;object-fit:cover;margin-right:8px;vertical-align:middle;"> <span>${sugg.strMeal}</span> <img class='heart-button' src='${heartSrc}' style='width:24px;cursor:pointer;vertical-align:middle;' title='Favori'>`;
                    div.addEventListener('click', function (e) {
                        if (e.target.classList.contains('heart-button')) {
                            e.stopPropagation();
                            let favorites = [];
                            try { favorites = JSON.parse(localStorage.getItem('gourmet-favorites')) || []; } catch (e) {}
                            const index = favorites.findIndex(fav => fav.id === sugg.idMeal);
                            if (index === -1) {
                                favorites.push({ id: sugg.idMeal });
                                div.querySelector('.heart-button').src = "../assets/icons/redHeart.png";
                            } else {
                                favorites.splice(index, 1);
                                div.querySelector('.heart-button').src = "../assets/icons/grayHeart.png";
                            }
                            localStorage.setItem('gourmet-favorites', JSON.stringify(favorites));
                        } else {
                            window.location.href = `recettes.html?recette=${sugg.idMeal}`;
                        }
                    });
                    suggestionsList.appendChild(div);
                });
            } else if (isApiRecipe && apiRecipe) {
                document.getElementById('titreRecette').textContent = apiRecipe.strMeal;
                document.getElementById('imageRecette').src = apiRecipe.strMealThumb;
                document.getElementById('imageRecette').alt = apiRecipe.strMeal;
                document.getElementById('categorieRecette').textContent = apiRecipe.strCategory;
                document.getElementById('tempsRecette').textContent = apiRecipe.strTags || '';
                document.getElementById('difficulteRecette').textContent = apiRecipe.strArea || '';
                document.getElementById('nbPersonnesRecette').textContent = '';

                // Favoris
                updateFavoriButton(apiRecipe.idMeal, true, apiRecipe.strMeal, apiRecipe.strMealThumb);

                // Ingr√©dients
                const ingredientsList = document.getElementById('ingredientsList');
                ingredientsList.innerHTML = '';
                for (let i = 1; i <= 20; i++) {
                    const ingredient = apiRecipe[`strIngredient${i}`];
                    const measure = apiRecipe[`strMeasure${i}`];
                    if (ingredient && ingredient.trim() !== '') {
                        const li = document.createElement('li');
                        li.textContent = `${ingredient}${measure ? ' - ' + measure : ''}`;
                        ingredientsList.appendChild(li);
                    }
                }

                // √âtapes
                const etapesList = document.getElementById('etapesList');
                etapesList.innerHTML = '';
                if (apiRecipe.strInstructions) {
                    apiRecipe.strInstructions.split(/\r?\n/).forEach(etape => {
                        if (etape.trim() !== '') {
                            const li = document.createElement('li');
                            li.textContent = etape.trim();
                            etapesList.appendChild(li);
                        }
                    });
                }

                // Suggestions API uniquement
                const suggestionsList = document.getElementById('suggestionsList');
                suggestionsList.innerHTML = '';
                const apiSuggestions = await fetchApiSuggestions(apiRecipe.strCategory);
                apiSuggestions.forEach(sugg => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-card';
                    // Ajout du bouton coeur
                    let favorites = [];
                    try { favorites = JSON.parse(localStorage.getItem('gourmet-favorites')) || []; } catch (e) {}
                    const isFavorite = favorites.some(fav => fav.id === sugg.idMeal);
                    const heartSrc = isFavorite ? "../assets/icons/redHeart.png" : "../assets/icons/grayHeart.png";
                    div.innerHTML = `<img src="${sugg.strMealThumb}" alt="${sugg.strMeal}" style="width:60px;height:60px;object-fit:cover;margin-right:8px;vertical-align:middle;"> <span>${sugg.strMeal}</span> <img class='heart-button' src='${heartSrc}' style='width:24px;cursor:pointer;vertical-align:middle;' title='Favori'>`;
                    div.addEventListener('click', function (e) {
                        if (e.target.classList.contains('heart-button')) {
                            e.stopPropagation();
                            let favorites = [];
                            try { favorites = JSON.parse(localStorage.getItem('gourmet-favorites')) || []; } catch (e) {}
                            const index = favorites.findIndex(fav => fav.id === sugg.idMeal);
                            if (index === -1) {
                                favorites.push({ id: sugg.idMeal });
                                div.querySelector('.heart-button').src = "../assets/icons/redHeart.png";
                            } else {
                                favorites.splice(index, 1);
                                div.querySelector('.heart-button').src = "../assets/icons/grayHeart.png";
                            }
                            localStorage.setItem('gourmet-favorites', JSON.stringify(favorites));
                        } else {
                            window.location.href = `recettes.html?recette=${sugg.idMeal}`;
                        }
                    });
                    suggestionsList.appendChild(div);
                });
            }
        });
        </script>
        </body>
    </html>